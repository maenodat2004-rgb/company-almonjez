<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monjez Hyper | Pro System</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary: #ff4e00;
    --primary-dark: #cc3e00;
    --secondary: #00c6ff;
    --secondary-dark: #0099cc;
    --gold: #f1c40f;
    --gold-dark: #d4ac0d;
    --bg: #0a0f1a;
    --card-bg: rgba(20, 25, 40, 0.8);
    --glass: rgba(255, 255, 255, 0.07);
    --border: rgba(255, 255, 255, 0.12);
    --text: #ffffff;
    --text-secondary: #a0aec0;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    --gradient: linear-gradient(135deg, #ff4e00 0%, #00c6ff 100%);
    --gradient-gold: linear-gradient(135deg, #f1c40f 0%, #ff9a00 100%);
    --gradient-green: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Cairo', sans-serif;
}

body {
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding-bottom: 90px;
    overflow-x: hidden;
    background-image: 
        radial-gradient(circle at 10% 20%, rgba(255, 78, 0, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(0, 198, 255, 0.05) 0%, transparent 20%);
}

.container {
    width: 92%;
    max-width: 480px;
    margin: 0 auto;
    padding-top: 20px;
}

.screen {
    display: none;
    animation: fadeIn 0.5s ease-out;
}

.active-screen {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

@keyframes newOrder {
    0% { transform: translateY(20px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

/* Login Overlay */
#login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.login-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 30px 25px;
    width: 100%;
    max-width: 380px;
    box-shadow: var(--shadow);
    text-align: center;
    animation: fadeIn 0.6s ease-out;
}

.login-header {
    margin-bottom: 30px;
}

.logo {
    font-size: 32px;
    font-weight: 900;
    margin-bottom: 10px;
    background: var(--gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    display: inline-block;
}

.login-subtitle {
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 300;
}

/* Cards */
.card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    padding: 25px;
    border-radius: 22px;
    text-align: center;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
}

/* Inputs */
.input-group {
    margin-bottom: 20px;
    text-align: right;
}

.input-label {
    display: block;
    margin-bottom: 8px;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 600;
}

input {
    width: 100%;
    padding: 16px 20px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    text-align: right;
    margin-bottom: 15px;
    outline: none;
    font-size: 16px;
    font-weight: 400;
    transition: all 0.3s ease;
}

input:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(0, 198, 255, 0.2);
    background: rgba(0, 0, 0, 0.4);
}

input::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Buttons */
.btn-main {
    width: 100%;
    padding: 18px;
    border-radius: 16px;
    border: none;
    background: var(--gradient);
    color: white;
    font-weight: 700;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    letter-spacing: 0.5px;
}

.btn-main:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
}

.btn-main:active {
    transform: translateY(-1px);
}

.btn-main:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
}

/* Stats Cards */
.stat-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-radius: 18px;
    margin-bottom: 15px;
    font-weight: 700;
    transition: transform 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: translateX(-100%);
}

.stat-card:hover::before {
    animation: shimmer 1.5s infinite;
}

.stat-card:hover {
    transform: translateX(-5px);
}

.bg-gradient-gold {
    background: var(--gradient-gold);
    color: #000;
}

.bg-gradient-red {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.bg-gradient-green {
    background: var(--gradient-green);
    color: white;
}

.stat-icon {
    font-size: 24px;
    margin-left: 10px;
}

.stat-value {
    font-size: 24px;
    font-weight: 800;
}

/* Timer */
.timer-box {
    font-size: 14px;
    color: var(--secondary);
    margin: 20px 0;
    font-weight: 600;
    background: rgba(0, 198, 255, 0.08);
    padding: 15px;
    border-radius: 14px;
    border: 1px solid rgba(0, 198, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.timer-box.warning {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
    color: var(--warning);
    animation: pulse 2s infinite;
}

.timer-box.danger {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    color: var(--danger);
    animation: shake 0.5s infinite;
}

.timer-icon {
    font-size: 18px;
}

/* Orders */
.order-card {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
    border: 1px solid var(--border);
    border-right: 5px solid var(--secondary);
    border-radius: 20px;
    padding: 22px;
    margin-bottom: 20px;
    text-align: right;
    transition: transform 0.3s ease;
    animation: newOrder 0.5s ease-out;
}

.order-card:hover {
    transform: translateX(-5px);
}

.order-card.taken {
    border-right: 5px solid var(--danger);
    opacity: 0.7;
}

.order-card.taken .taken-badge {
    display: block;
}

.order-card.own-order {
    border-right: 5px solid var(--warning);
    background: linear-gradient(145deg, rgba(245, 158, 11, 0.08), rgba(245, 158, 11, 0.02));
}

.order-card.own-order .own-badge {
    display: block;
}

.taken-badge, .own-badge {
    display: none;
    padding: 8px 15px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 700;
    margin-bottom: 15px;
    text-align: center;
}

.taken-badge {
    background: var(--danger);
    color: white;
}

.own-badge {
    background: var(--warning);
    color: #000;
}

.loc-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 8px;
}

.loc-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    flex-shrink: 0;
}

.dot-start {
    background: var(--secondary);
    box-shadow: 0 0 10px rgba(0, 198, 255, 0.5);
}

.dot-end {
    background: var(--primary);
    box-shadow: 0 0 10px rgba(255, 78, 0, 0.5);
}

.loc-label {
    font-size: 12px;
    color: var(--text-secondary);
    display: block;
    margin-bottom: 2px;
}

.loc-text {
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
}

.price-badge {
    background: rgba(0, 0, 0, 0.3);
    padding: 14px 22px;
    border-radius: 16px;
    border: 1px solid var(--gold);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    background: linear-gradient(90deg, rgba(241, 196, 15, 0.1), rgba(255, 154, 0, 0.1));
}

.price-badge span:last-child {
    color: var(--gold);
    font-size: 20px;
    font-weight: 800;
}

/* Navigation */
.nav-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 80px;
    background: rgba(15, 20, 35, 0.95);
    backdrop-filter: blur(20px);
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top: 1px solid var(--border);
    z-index: 1000;
    padding: 0 10px;
}

.nav-item {
    color: var(--text-secondary);
    text-align: center;
    cursor: pointer;
    font-size: 12px;
    flex: 1;
    padding: 12px 5px;
    border-radius: 16px;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.nav-item:hover {
    color: var(--secondary);
    background: rgba(0, 198, 255, 0.05);
}

.nav-item.active {
    color: var(--secondary);
    font-weight: 800;
    background: rgba(0, 198, 255, 0.1);
}

.nav-icon {
    font-size: 22px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 50px 20px;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Headers */
.screen-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border);
}

.screen-title {
    font-size: 24px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 10px;
}

.screen-title-icon {
    color: var(--secondary);
}

/* Welcome Message */
.welcome-message {
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.welcome-name {
    background: var(--gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
}

/* Inventory Status */
.inventory-status {
    margin: 15px 0;
    padding: 15px;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border);
}

.inventory-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.inventory-row:last-child {
    margin-bottom: 0;
    padding-top: 8px;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-weight: 700;
    color: var(--secondary);
}

/* Commission Details */
.commission-details {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 15px;
    margin: 15px 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 14px;
}

.commission-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
}

.commission-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
    font-weight: 700;
    color: var(--gold);
}

.commission-label {
    color: var(--text-secondary);
}

.commission-value {
    font-weight: 600;
}

/* Logout Button */
#logoutBtn {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: var(--danger);
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 15px;
    transition: all 0.3s ease;
    width: auto;
    display: inline-block;
}

#logoutBtn:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: translateY(-2px);
}

/* Progress Bar */
.progress-container {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    margin: 15px 0;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: var(--gradient);
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* Sound Notification */
.sound-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--gradient);
    color: white;
    padding: 15px 20px;
    border-radius: 15px;
    display: none;
    align-items: center;
    gap: 10px;
    z-index: 3000;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease-out;
}

/* Responsive */
@media (max-width: 480px) {
    .container {
        width: 95%;
    }
    
    .card, .login-card {
        padding: 20px;
    }
    
    .nav-icon {
        font-size: 20px;
    }
    
    .nav-item {
        font-size: 11px;
        padding: 10px 5px;
    }
    
    .welcome-message {
        font-size: 20px;
    }
    
    .stat-value {
        font-size: 22px;
    }
    
    .sound-notification {
        top: 10px;
        right: 10px;
        left: 10px;
    }
}

@keyframes shimmer {
    100% { transform: translateX(100%); }
}
</style>
</head>
<body>

<!-- Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØµÙˆØª -->
<div id="soundNotification" class="sound-notification">
    <i class="fas fa-bell"></i>
    <span id="notificationText">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…ØªÙˆÙØ±!</span>
</div>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="login-overlay">
    <div class="login-card">
        <div class="login-header">
            <div class="logo">MONJEZ HYPER</div>
            <div class="login-subtitle">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</div>
        </div>
        
        <div class="input-group">
            <label class="input-label" for="userIdInput">
                <i class="fas fa-id-card"></i> Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ
            </label>
            <input id="userIdInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ Ù‡Ù†Ø§">
        </div>
        
        <button class="btn-main" id="loginBtn">
            <i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
        </button>
        
        <div style="margin-top: 20px; font-size: 13px; color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i> Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø®ØµØµ Ù„Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
        </div>
    </div>
</div>

<div class="container">
    <!-- Ø§Ù„ØµÙØ­Ø© 1: Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
    <div id="screen-profile" class="screen">
        <div class="screen-header">
            <div class="screen-title">
                <i class="fas fa-user-circle screen-title-icon"></i>
                Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            </div>
            <div style="color: var(--text-secondary); font-size: 14px;">
                <i class="fas fa-circle" style="color: var(--success); font-size: 10px;"></i> Ù…ØªØµÙ„
            </div>
        </div>
        
        <div class="card">
            <div class="welcome-message">
                <i class="fas fa-hand-wave"></i>
                Ø£Ù‡Ù„Ø§Ù‹ <span id="welcomeName" class="welcome-name">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
            </div>
            
            <!-- Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø±Ø¯ -->
            <div class="progress-container">
                <div class="progress-bar" id="inventoryProgress" style="width: 0%"></div>
            </div>
            
            <!-- Ù…Ø¤Ù‚Øª Ø§Ù„Ø¬Ø±Ø¯ -->
            <div class="timer-box" id="jard-timer">
                <i class="fas fa-clock timer-icon"></i>
                <span>Ø¬Ø§Ø±Ù Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø¬Ø±Ø¯...</span>
            </div>
            
            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="inventory-status">
                <div class="inventory-row">
                    <span>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯:</span>
                    <span id="inventory-start">--</span>
                </div>
                <div class="inventory-row">
                    <span>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯:</span>
                    <span id="inventory-end">--</span>
                </div>
                <div class="inventory-row">
                    <span>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø®Ù„Ø§Ù„ Ø§Ù„Ø¬Ø±Ø¯:</span>
                    <span id="inventory-earnings">0.00 Ø¯.Ø£</span>
                </div>
                <div class="inventory-row">
                    <span>Ø°Ù…Ù… Ø®Ù„Ø§Ù„ Ø§Ù„Ø¬Ø±Ø¯:</span>
                    <span id="inventory-dues">0.00 Ø¯.Ø£</span>
                </div>
            </div>
            
            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© -->
            <div id="lastCommissionDetails" class="commission-details" style="display: none;">
                <div style="color: var(--secondary); font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-calculator"></i>
                    <span>ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©</span>
                </div>
                <div class="commission-row">
                    <span class="commission-label">Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨:</span>
                    <span class="commission-value" id="last-order-price">0.00 Ø¯.Ø£</span>
                </div>
                <div class="commission-row">
                    <span class="commission-label">ÙŠØ¯ÙØ¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</span>
                    <span class="commission-value" id="last-captain-pays">0.00 Ø¯.Ø£</span>
                </div>
                <div class="commission-row">
                    <span class="commission-label">Ø­ØµØ© Ø§Ù„Ù…Ù†ØªØ¬ (70%):</span>
                    <span class="commission-value" id="last-product-share">0.00 Ø¯.Ø£</span>
                </div>
                <div class="commission-row">
                    <span class="commission-label">Ø­ØµØ© Ø§Ù„Ø´Ø±ÙƒØ© (30%):</span>
                    <span class="commission-value" id="last-company-share">0.00 Ø¯.Ø£</span>
                </div>
                <div class="commission-row">
                    <span class="commission-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­:</span>
                    <span class="commission-value" id="last-net-profit">0.00 Ø¯.Ø£</span>
                </div>
            </div>
            
            <!-- Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø© -->
            <div class="stat-card bg-gradient-green">
                <div>
                    <i class="fas fa-chart-line stat-icon"></i>
                    <div>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©</div>
                </div>
                <div class="stat-value" id="total-earnings">0.00 Ø¯.Ø£</div>
            </div>
            
            <div class="stat-card bg-gradient-gold">
                <div>
                    <i class="fas fa-wallet stat-icon"></i>
                    <div>Ù…Ø³ØªØ­Ù‚Ø§ØªÙƒ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©</div>
                </div>
                <div class="stat-value" id="txt-in">0.00 Ø¯.Ø£</div>
            </div>
            
            <div class="stat-card bg-gradient-red">
                <div>
                    <i class="fas fa-file-invoice-dollar stat-icon"></i>
                    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©</div>
                </div>
                <div class="stat-value" id="txt-out">0.00 Ø¯.Ø£</div>
            </div>
            
            <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù… -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #3b82f6;">
                    <i class="fas fa-calendar-check"></i>
                    <span style="font-weight: 700;">Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù…</span>
                </div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                    <span id="next-inventory-time">--</span>
                    <br>
                    <span style="font-size: 12px;">Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ø°Ù…Ù… ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span>
                </div>
            </div>
            
            <button id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </div>

    <!-- Ø§Ù„ØµÙØ­Ø© 2: Ø§Ù„ÙƒØ¨Ø§ØªÙ† -->
    <div id="screen-radar" class="screen">
        <div class="screen-header">
            <div class="screen-title">
                <i class="fas fa-satellite-dish screen-title-icon"></i>
                Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            </div>
            <div style="color: var(--secondary); font-size: 14px; font-weight: 600;">
                <i class="fas fa-sync-alt" style="margin-left: 5px;"></i> Ù…Ø­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            </div>
        </div>
        
        <div id="radar-list"></div>
    </div>

    <!-- Ø§Ù„ØµÙØ­Ø© 3: Ø§Ù„ØªØ§Ø¬Ø± / Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨ -->
    <div id="screen-merchant" class="screen">
        <div class="screen-header">
            <div class="screen-title">
                <i class="fas fa-store screen-title-icon"></i>
                Ù†Ø´Ø± Ø·Ù„Ø¨ Ø¨Ø¶Ø§Ø¹Ø©
            </div>
            <div style="color: var(--text-secondary); font-size: 14px;">
                <i class="fas fa-user-tie" style="margin-left: 5px;"></i> ÙˆØ¶Ø¹ Ø§Ù„ØªØ§Ø¬Ø±
            </div>
        </div>
        
        <div class="card">
            <div class="input-group">
                <label class="input-label" for="p-from">
                    <i class="fas fa-map-marker-alt"></i> Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
                </label>
                <input id="p-from" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨">
            </div>
            
            <div class="input-group">
                <label class="input-label" for="p-to">
                    <i class="fas fa-flag-checkered"></i> Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…
                </label>
                <input id="p-to" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨">
            </div>
            
            <div class="input-group">
                <label class="input-label" for="p-price">
                    <i class="fas fa-money-bill-wave"></i> Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ)
                </label>
                <input id="p-price" type="number" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„">
            </div>
            
            <div class="input-group">
                <label class="input-label" for="p-commission">
                    <i class="fas fa-hand-holding-usd"></i> Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ÙŠØ¯ÙØ¹Ù‡ Ø§Ù„ÙƒØ§Ø¨ØªÙ†)
                </label>
                <input id="p-commission" type="number" placeholder="Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©">
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    <i class="fas fa-info-circle"></i> Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¯ÙØ¹Ù‡ Ø§Ù„ÙƒØ§Ø¨ØªÙ†ØŒ Ø«Ù… ÙŠÙ‚Ø³Ù… 70% Ù„Ù„Ù…Ù†ØªØ¬ Ùˆ30% Ù„Ù„Ø´Ø±ÙƒØ©
                </div>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 198, 255, 0.1); border-radius: 12px; border: 1px dashed rgba(0, 198, 255, 0.3);">
                <div style="color: var(--secondary); font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-info-circle"></i>
                    <span>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</span>
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                    <div>â€¢ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ØªÙŠ ÙŠØ¯ÙØ¹Ù‡Ø§ Ø§Ù„ÙƒØ§Ø¨ØªÙ†</div>
                    <div style="margin-top: 8px; color: var(--gold);">
                        Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ØªÙ‚Ø³Ù…: 70% Ù„Ù„Ù…Ù†ØªØ¬ØŒ 30% Ù„Ù„Ø´Ø±ÙƒØ©
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: var(--warning);">
                        <i class="fas fa-exclamation-triangle"></i> Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ø®Ø° Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©
                    </div>
                </div>
            </div>
            
            <button class="btn-main" id="createOrderBtn">
                <i class="fas fa-paper-plane"></i> Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨
            </button>
            
            <div style="margin-top: 20px; padding: 15px; background: rgba(0, 198, 255, 0.05); border-radius: 12px; font-size: 13px; color: var(--text-secondary); border: 1px dashed rgba(0, 198, 255, 0.3);">
                <i class="fas fa-lightbulb" style="color: var(--secondary); margin-left: 5px;"></i>
                Ø³ÙŠØ¸Ù‡Ø± Ø·Ù„Ø¨Ùƒ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ÙƒØ¨Ø§ØªÙ†
            </div>
        </div>
    </div>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ -->
<nav class="nav-bar" id="main-nav" style="display:none;">
    <div class="nav-item" id="nav-profile">
        <i class="fas fa-user-circle nav-icon"></i>
        <span>Ø§Ù„Ø­Ø³Ø§Ø¨</span>
    </div>
    <div class="nav-item" id="nav-radar">
        <i class="fas fa-shipping-fast nav-icon"></i>
        <span>Ø§Ù„ÙƒØ¨Ø§ØªÙ†</span>
    </div>
    <div class="nav-item" id="nav-merchant">
        <i class="fas fa-store nav-icon"></i>
        <span>Ø§Ù„ØªØ§Ø¬Ø±</span>
    </div>
</nav>

<audio id="newOrderSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
<audio id="orderTakenSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
<audio id="inventorySound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.wav" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, onSnapshot, serverTimestamp, increment, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = {
  apiKey: "AIzaSyABQ1Ftw9rQyL42YNvA5yJVQX62ZLkYmag",
  authDomain: "last-monjez.firebaseapp.com",
  projectId: "last-monjez",
  storageBucket: "last-monjez.firebasestorage.app",
  messagingSenderId: "62629418128",
  appId: "1:62629418128:web:8998fe807471f2a5ea7415",
  measurementId: "G-MLK4DJDJSN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let uDocId = null;
let uData = null;
let isFirstLoad = true;
let currentInventoryId = null;
let inventoryInterval = null;
let lastOrders = new Set();

// ============================================
// ğŸ”Š Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø±Ø¦ÙŠ
// ============================================
function playSound(type, message = "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…ØªÙˆÙØ±!") {
    try {
        let sound;
        switch(type) {
            case 'newOrder':
                sound = document.getElementById('newOrderSound');
                break;
            case 'orderTaken':
                sound = document.getElementById('orderTakenSound');
                break;
            case 'inventory':
                sound = document.getElementById('inventorySound');
                break;
            default:
                sound = document.getElementById('newOrderSound');
        }
        
        sound.currentTime = 0;
        sound.play().catch(e => {
            console.log("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e);
        });
        
        if (message) {
            document.getElementById('notificationText').textContent = message;
            const notification = document.getElementById('soundNotification');
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", error);
    }
}

// ============================================
// ğŸ”„ Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ­Ø¯Ø¯Ù‡Ø§)
// ============================================
function calculateCommission(price, commission) {
    // commission Ù‡Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ÙŠØ­Ø¯Ø¯Ù‡ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆÙŠØ¯ÙØ¹Ù‡ Ø§Ù„ÙƒØ§Ø¨ØªÙ†
    
    // Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ£Ø®Ø° 70% Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
    let productShare = parseFloat((commission * 0.7).toFixed(2));
    
    // Ø§Ù„Ø´Ø±ÙƒØ© ØªØ£Ø®Ø° 30% Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
    let companyShare = parseFloat((commission * 0.3).toFixed(2));
    
    // ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„ÙƒØ§Ø¨ØªÙ† = Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨ - Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
    let netProfit = parseFloat((price - commission).toFixed(2));
    
    return {
        captainPays: commission,
        productShare: productShare,
        companyShare: companyShare,
        netProfit: netProfit
    };
}

// ============================================
// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
// ============================================
function showCommissionDetails(price, commission) {
    const commissionDetails = calculateCommission(price, commission);
    
    document.getElementById('lastCommissionDetails').style.display = 'block';
    document.getElementById('last-order-price').textContent = price.toFixed(2) + ' Ø¯.Ø£';
    document.getElementById('last-captain-pays').textContent = commissionDetails.captainPays.toFixed(2) + ' Ø¯.Ø£';
    document.getElementById('last-product-share').textContent = commissionDetails.productShare.toFixed(2) + ' Ø¯.Ø£';
    document.getElementById('last-company-share').textContent = commissionDetails.companyShare.toFixed(2) + ' Ø¯.Ø£';
    document.getElementById('last-net-profit').textContent = commissionDetails.netProfit.toFixed(2) + ' Ø¯.Ø£';
}

// Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
const navTo = (screenId, el) => {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.getElementById(screenId).classList.add('active-screen');
    if(el) el.classList.add('active');
};

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
async function doLogin(){
    const id = document.getElementById('userIdInput').value.trim();
    if(!id) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ");

    const loginBtn = document.getElementById('loginBtn');
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
    loginBtn.disabled = true;

    try {
        const qUsers = query(collection(db, "users"), where("loginId", "==", id));
        const snap = await getDocs(qUsers);

        if(snap.empty){ 
            alert("âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"); 
            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…';
            loginBtn.disabled = false;
            return; 
        }

        snap.forEach(d => {
            uDocId = d.id;
            uData = d.data();
        });

        localStorage.setItem('uDocId', uDocId);
        initApp();

    } catch(e){
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        console.error(e);
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…';
        loginBtn.disabled = false;
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function initApp(){
    document.getElementById('login-overlay').style.display='none';
    document.getElementById('main-nav').style.display='flex';
    navTo('screen-profile', document.getElementById('nav-profile'));
    initializeInventorySystem();
    listenBalances();
    listenOrders();
}

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
async function initializeInventorySystem() {
    try {
        const inventoryRef = doc(db, "inventories", `${uData.loginId}_current`);
        const inventorySnap = await getDoc(inventoryRef);
        
        if (inventorySnap.exists()) {
            currentInventoryId = inventorySnap.id;
            const inventoryData = inventorySnap.data();
            startInventoryTimer(inventoryData.startTime.toDate());
        } else {
            await createNewInventory();
        }
        
        listenToInventory();
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯:", error);
    }
}

async function createNewInventory() {
    try {
        const now = new Date();
        const startTime = new Date(now);
        startTime.setHours(0, 0, 0, 0);
        
        if (now.getHours() >= 0) {
            startTime.setDate(now.getDate());
        } else {
            startTime.setDate(now.getDate() - 1);
        }
        
        const endTime = new Date(startTime);
        endTime.setHours(endTime.getHours() + 48);
        
        const nextInventoryTime = new Date(endTime);
        nextInventoryTime.setHours(0, 0, 0, 0);
        
        const inventoryData = {
            userId: uData.loginId,
            userName: uData.name || uData.loginId,
            startTime: startTime,
            endTime: endTime,
            nextInventoryTime: nextInventoryTime,
            earnings: 0,
            dues: 0,
            status: "active",
            createdAt: serverTimestamp()
        };
        
        const inventoryRef = doc(db, "inventories", `${uData.loginId}_current`);
        await setDoc(inventoryRef, inventoryData);
        
        currentInventoryId = inventoryRef.id;
        startInventoryTimer(startTime);
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø±Ø¯:", error);
    }
}

function startInventoryTimer(startTime) {
    if (inventoryInterval) clearInterval(inventoryInterval);
    
    inventoryInterval = setInterval(() => {
        const now = new Date();
        const start = new Date(startTime);
        const end = new Date(start);
        end.setHours(end.getHours() + 48);
        
        const totalTime = 48 * 60 * 60 * 1000;
        const elapsed = now.getTime() - start.getTime();
        const remaining = Math.max(end.getTime() - now.getTime(), 0);
        
        const percentage = Math.min((elapsed / totalTime) * 100, 100);
        document.getElementById('inventoryProgress').style.width = percentage + '%';
        
        const hours = Math.floor(remaining / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
        
        const timerBox = document.getElementById('jard-timer');
        timerBox.innerHTML = `<i class="fas fa-clock timer-icon"></i> Ø§Ù„Ø¬Ø±Ø¯ ÙŠÙ†Ù‡ÙŠ Ø®Ù„Ø§Ù„: <span style="font-weight:800;">${hours}Ø³ ${minutes}Ø¯ ${seconds}Ø«</span>`;
        
        document.getElementById('inventory-start').textContent = formatTime(start);
        document.getElementById('inventory-end').textContent = formatTime(end);
        
        const nextInventory = new Date(end);
        nextInventory.setHours(0, 0, 0, 0);
        document.getElementById('next-inventory-time').textContent = formatTime(nextInventory);
        
        timerBox.classList.remove('warning', 'danger');
        if (hours < 2) {
            timerBox.classList.add('danger');
        } else if (hours < 12) {
            timerBox.classList.add('warning');
        }
        
        if (remaining <= 1000 && remaining > 0) {
            executeInventoryEnd();
        }
        
    }, 1000);
}

async function executeInventoryEnd() {
    try {
        const inventoryRef = doc(db, "inventories", `${uData.loginId}_current`);
        const inventorySnap = await getDoc(inventoryRef);
        
        if (!inventorySnap.exists()) return;
        
        const inventoryData = inventorySnap.data();
        
        const endedInventoryRef = doc(collection(db, "ended_inventories"));
        await setDoc(endedInventoryRef, {
            ...inventoryData,
            endedAt: serverTimestamp(),
            status: "completed"
        });
        
        const userRef = doc(db, "users", uDocId);
        await updateDoc(userRef, {
            totalEarnings: increment(inventoryData.earnings),
            totalDues: increment(inventoryData.dues),
            lastInventory: serverTimestamp()
        });
        
        const newStartTime = new Date(inventoryData.nextInventoryTime);
        const newEndTime = new Date(newStartTime);
        newEndTime.setHours(newEndTime.getHours() + 48);
        
        const nextInventoryTime = new Date(newEndTime);
        nextInventoryTime.setHours(0, 0, 0, 0);
        
        await updateDoc(inventoryRef, {
            startTime: newStartTime,
            endTime: newEndTime,
            nextInventoryTime: nextInventoryTime,
            earnings: 0,
            dues: 0,
            lastReset: serverTimestamp()
        });
        
        playSound('inventory', "ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ");
        
        alert("âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ®ØµÙ… Ø§Ù„Ø°Ù…Ù… Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.");
        
        startInventoryTimer(newStartTime);
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¬Ø±Ø¯ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
    }
}

function listenToInventory() {
    const inventoryRef = doc(db, "inventories", `${uData.loginId}_current`);
    
    onSnapshot(inventoryRef, (snap) => {
        if (!snap.exists()) return;
        
        const data = snap.data();
        
        document.getElementById('inventory-earnings').textContent = 
            (data.earnings || 0).toFixed(2) + ' Ø¯.Ø£';
        document.getElementById('inventory-dues').textContent = 
            (data.dues || 0).toFixed(2) + ' Ø¯.Ø£';
        
        if (data.startTime && !inventoryInterval) {
            startInventoryTimer(data.startTime.toDate());
        }
    });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
function listenBalances(){
    const userRef = doc(db, "users", uDocId);
    
    onSnapshot(userRef, (d) => {
        if(!d.exists()) return;
        
        uData = d.data();
        document.getElementById('welcomeName').innerText = uData.name || uData.loginId;
        
        const totalEarnings = (uData.totalEarnings || 0);
        document.getElementById('total-earnings').textContent = totalEarnings.toFixed(2) + ' Ø¯.Ø£';
        
        const currentEarnings = (uData.driverEarnings || 0) + (uData.merchantEarnings || 0);
        document.getElementById('txt-in').textContent = currentEarnings.toFixed(2) + ' Ø¯.Ø£';
        
        const totalDues = (uData.totalDues || 0) + (uData.companyDues || 0);
        document.getElementById('txt-out').textContent = totalDues.toFixed(2) + ' Ø¯.Ø£';
    });
}

// Ù†Ø´Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
async function createOrder(){
    const f=document.getElementById('p-from').value.trim(),
          t=document.getElementById('p-to').value.trim(),
          p=parseFloat(document.getElementById('p-price').value.trim()),
          c=parseFloat(document.getElementById('p-commission').value.trim());
    
    if(!f || !t || !p || !c) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    if(p <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØªÙˆØµÙŠÙ„ ØµØ­ÙŠØ­");
    if(c <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¹Ù…ÙˆÙ„Ø© ØµØ­ÙŠØ­Ø©");
    if(c >= p) return alert("Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨ Ø­ØªÙ‰ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø±Ø¨Ø­ Ù„Ù„ÙƒØ§Ø¨ØªÙ†");

    const createBtn = document.getElementById('createOrderBtn');
    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...';
    createBtn.disabled = true;

    try {
        await addDoc(collection(db, "orders"), {
            from: f, 
            to: t, 
            price: p, 
            commission: c,
            status: "open",
            sender: uData.loginId, 
            senderName: uData.name||uData.loginId, 
            createdAt: serverTimestamp()
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('p-from').value = '';
        document.getElementById('p-to').value = '';
        document.getElementById('p-price').value = '';
        document.getElementById('p-commission').value = '';
        
        playSound('newOrder', "ØªÙ… Ù†Ø´Ø± Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
        alert("âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
        navTo('screen-radar', document.getElementById('nav-radar'));
        
    } catch(e) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨");
        console.error(e);
    } finally {
        createBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨';
        createBtn.disabled = false;
    }
}

// ============================================
// ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
// ============================================
function listenOrders(){
    onSnapshot(query(collection(db, "orders"), where("status", "in", ["open", "taken"])), snap => {
        const list = document.getElementById('radar-list');
        
        const newOrders = [];
        snap.forEach(d => {
            if (d.data().status === "open" && !lastOrders.has(d.id)) {
                newOrders.push(d.id);
                lastOrders.add(d.id);
            }
        });
        
        if (!isFirstLoad && newOrders.length > 0) {
            playSound('newOrder', `ÙŠÙˆØ¬Ø¯ ${newOrders.length} Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯`);
        }
        
        isFirstLoad = false;
        
        if(snap.empty) {
            list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-search-location"></i>
                    </div>
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px; color: var(--text-secondary);">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹
                    </div>
                    <div style="font-size: 14px;">
                        Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙˆØ± ØªÙˆÙØ±Ù‡Ø§
                    </div>
                </div>
            `;
            return;
        }
        
        list.innerHTML = '';
        const ordersArray = [];
        
        snap.forEach(d => {
            const o = d.data();
            ordersArray.push({
                id: d.id,
                data: o,
                isOpen: o.status === "open",
                isOwnOrder: o.sender === uData.loginId,
                createdAt: o.createdAt ? o.createdAt.toDate() : new Date()
            });
        });
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ø£Ø®ÙˆØ°Ø©
        ordersArray.sort((a, b) => {
            if (a.isOpen && !b.isOpen) return -1;
            if (!a.isOpen && b.isOpen) return 1;
            return b.createdAt - a.createdAt;
        });
        
        ordersArray.forEach(item => {
            const o = item.data;
            const commissionDetails = calculateCommission(o.price, o.commission);
            const isTaken = o.status === "taken";
            const isOwnOrder = item.isOwnOrder;
            
            const card = document.createElement('div');
            card.className = `order-card ${isTaken ? 'taken' : ''} ${isOwnOrder && !isTaken ? 'own-order' : ''}`;
            card.innerHTML = `
                ${isTaken ? `
                    <div class="taken-badge">
                        <i class="fas fa-exclamation-triangle"></i> Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø£Ø®Ø°Ù‡
                    </div>
                ` : ''}
                
                ${isOwnOrder && !isTaken ? `
                    <div class="own-badge">
                        <i class="fas fa-user-tag"></i> Ù‡Ø°Ø§ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ
                    </div>
                ` : ''}
                
                <div class="loc-row">
                    <div class="loc-dot dot-start"></div>
                    <div>
                        <span class="loc-label">Ù…Ù†</span>
                        <span class="loc-text">${o.from}</span>
                    </div>
                </div>
                <div class="loc-row">
                    <div class="loc-dot dot-end"></div>
                    <div>
                        <span class="loc-label">Ø¥Ù„Ù‰</span>
                        <span class="loc-text">${o.to}</span>
                    </div>
                </div>
                <div style="margin: 10px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px; font-size: 14px;">
                    <i class="fas fa-user" style="color: var(--secondary); margin-left: 5px;"></i>
                    <span>Ø§Ù„Ù†Ø§Ø´Ø±: ${o.senderName || o.sender}</span>
                </div>
                
                ${!isTaken ? `
                    <div style="margin: 10px 0; padding: 12px; background: rgba(0, 198, 255, 0.1); border-radius: 12px; border-left: 3px solid var(--secondary); font-size: 13px;">
                        <div style="color: var(--secondary); font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-calculator"></i>
                            <span>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨:</span>
                            <span style="color: var(--gold); font-weight: 700;">${o.price} Ø¯.Ø£</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>ÙŠØ¯ÙØ¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</span>
                            <span style="color: var(--warning);">${o.commission} Ø¯.Ø£</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</span>
                            <span style="color: var(--success); font-weight: 700;">${commissionDetails.netProfit.toFixed(2)} Ø¯.Ø£</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px; padding-top: 5px; border-top: 1px dashed rgba(255,255,255,0.1);">
                            <span>Ø­ØµØ© Ø§Ù„Ù…Ù†ØªØ¬ (70%):</span>
                            <span style="color: var(--primary);">${commissionDetails.productShare.toFixed(2)} Ø¯.Ø£</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>Ø­ØµØ© Ø§Ù„Ø´Ø±ÙƒØ© (30%):</span>
                            <span style="color: var(--danger);">${commissionDetails.companyShare.toFixed(2)} Ø¯.Ø£</span>
                        </div>
                    </div>
                ` : `
                    <div style="margin: 10px 0; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; border-left: 3px solid var(--danger); font-size: 13px;">
                        <div style="color: var(--danger); font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-info-circle"></i>
                            <span>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨:</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>ØªÙ… Ø£Ø®Ø°Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø©:</span>
                            <span style="color: var(--warning);">${o.courier || 'ÙƒØ§Ø¨ØªÙ† Ø¢Ø®Ø±'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                            <span style="color: var(--danger); font-weight: 700;">ØºÙŠØ± Ù…ØªØ§Ø­</span>
                        </div>
                    </div>
                `}
                
                ${!isTaken && !isOwnOrder ? `
                    <button class="btn-main" style="margin-top: 20px; padding: 15px;" id="btn-${item.id}">
                        <i class="fas fa-check-circle"></i> Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                ` : ''}
                
                ${!isTaken && isOwnOrder ? `
                    <button class="btn-main" style="margin-top: 20px; padding: 15px; background: rgba(245, 158, 11, 0.5); cursor: not-allowed;" disabled>
                        <i class="fas fa-user-tag"></i> Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„Ù‡)
                    </button>
                ` : ''}
                
                ${isTaken ? `
                    <button class="btn-main" style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.5); cursor: not-allowed;" disabled>
                        <i class="fas fa-times-circle"></i> ØºÙŠØ± Ù…ØªØ§Ø­
                    </button>
                ` : ''}
            `;
            list.appendChild(card);
            
            if (!isTaken && !isOwnOrder) {
                document.getElementById(`btn-${item.id}`).onclick = () => acceptOrder(item.id, o.price, o.commission);
            }
        });
        
        setTimeout(() => {
            snap.forEach(d => {
                if (d.data().status === "open") {
                    lastOrders.add(d.id);
                }
            });
        }, 1000);
    });
}

// Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
async function acceptOrder(id, price, commission){
    const btn = document.getElementById(`btn-${id}`);
    if (!btn) return;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø¨ÙˆÙ„...';
    btn.disabled = true;
    
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…ØªØ§Ø­Ø§Ù‹
        const orderRef = doc(db, "orders", id);
        const orderSnap = await getDoc(orderRef);
        
        if (!orderSnap.exists() || orderSnap.data().status !== "open") {
            throw new Error("Ø§Ù„Ø·Ù„Ø¨ Ù„Ù… ÙŠØ¹Ø¯ Ù…ØªØ§Ø­Ø§Ù‹");
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡
        const orderData = orderSnap.data();
        if (orderData.sender === uData.loginId) {
            throw new Error("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ");
        }
        
        const commissionDetails = calculateCommission(price, commission);
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
        await updateDoc(orderRef, { 
            status: "taken", 
            courier: uData.loginId,
            takenAt: serverTimestamp(),
            captainPays: commissionDetails.captainPays,
            productShare: commissionDetails.productShare,
            companyShare: commissionDetails.companyShare,
            netProfit: commissionDetails.netProfit
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„ÙƒØ§Ø¨ØªÙ†)
        const userRef = doc(db, "users", uDocId);
        await updateDoc(userRef, { 
            driverEarnings: increment(commissionDetails.netProfit), 
            companyDues: increment(commissionDetails.companyShare)
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨)
        if (orderData.sender) {
            const senderQuery = query(collection(db, "users"), where("loginId", "==", orderData.sender));
            const senderSnap = await getDocs(senderQuery);
            if (!senderSnap.empty) {
                const senderDoc = senderSnap.docs[0];
                await updateDoc(senderDoc.ref, {
                    merchantEarnings: increment(commissionDetails.productShare)
                });
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const inventoryRef = doc(db, "inventories", `${uData.loginId}_current`);
        await updateDoc(inventoryRef, {
            earnings: increment(commissionDetails.netProfit),
            dues: increment(commissionDetails.companyShare)
        });
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„
        playSound('orderTaken', "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
        
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
        showCommissionDetails(price, commission);
        
        alert(`âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­\nğŸ“Š ØµØ§ÙÙŠ Ø±Ø¨Ø­Ùƒ: ${commissionDetails.netProfit} Ø¯.Ø£\nğŸ’³ Ø¯ÙØ¹ Ù„Ù„ÙƒØ§Ø¨ØªÙ†: ${commissionDetails.captainPays} Ø¯.Ø£`);
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
        navTo('screen-profile', document.getElementById('nav-profile'));
        
    } catch(e) { 
        console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨:", e);
        
        if (e.message === "Ø§Ù„Ø·Ù„Ø¨ Ù„Ù… ÙŠØ¹Ø¯ Ù…ØªØ§Ø­Ø§Ù‹") {
            playSound('orderTaken', "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­!");
            alert("âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø£Ø®Ø°Ù‡ Ù…Ù† Ù‚Ø¨Ù„ ÙƒØ§Ø¨ØªÙ† Ø¢Ø®Ø±");
        } else if (e.message === "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ") {
            playSound('orderTaken', "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ!");
            alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ");
        } else {
            playSound('orderTaken', "Ø­Ø¯Ø« Ø®Ø·Ø£!");
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨");
        }
        
        if (btn) {
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨';
            btn.disabled = false;
        }
    }
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
function formatTime(date) {
    if (!date) return '--';
    
    const d = date instanceof Date ? date : date.toDate();
    return d.toLocaleDateString('ar-EG', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ============================================
// Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
// ============================================
document.getElementById('loginBtn').onclick = doLogin;
document.getElementById('createOrderBtn').onclick = createOrder;
document.getElementById('logoutBtn').onclick = () => { 
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        if (inventoryInterval) clearInterval(inventoryInterval);
        localStorage.clear(); 
        location.reload(); 
    }
};

// Ø¥Ø¶Ø§ÙØ© Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø²Ø± Enter
document.getElementById('userIdInput').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') doLogin();
});

document.getElementById('p-from').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') document.getElementById('p-to').focus();
});

document.getElementById('p-to').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') document.getElementById('p-price').focus();
});

document.getElementById('p-price').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') document.getElementById('p-commission').focus();
});

document.getElementById('p-commission').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') createOrder();
});

// Ø§Ù„ØªÙ†Ù‚Ù„
document.getElementById('nav-profile').onclick = (e) => navTo('screen-profile', e.currentTarget);
document.getElementById('nav-radar').onclick = (e) => navTo('screen-radar', e.currentTarget);
document.getElementById('nav-merchant').onclick = (e) => navTo('screen-merchant', e.currentTarget);

</script>

</body>
</html> 